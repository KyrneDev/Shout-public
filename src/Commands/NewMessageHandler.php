<?php
namespace Kyrne\Shout\Commands; use Flarum\User\Exception\PermissionDeniedException; use Flarum\User\User; use Kyrne\Shout\Conversation; use Kyrne\Shout\ConversationUser; use Kyrne\Shout\Message; use Pusher\Pusher; class NewMessageHandler { public function handle(NewMessage $sp6a6b12) { $spd4bab0 = $sp6a6b12->actor; $sp2b7469 = $sp6a6b12->data; $sp71a176 = $sp6a6b12->conversationId; if ($sp71a176) { $sp12718f = Conversation::find($sp71a176); } else { $sp12718f = Conversation::find($sp2b7469['attributes']['conversationId']); } if (!$sp12718f->recipients()->where('user_id', $spd4bab0->id)->get()) { throw new PermissionDeniedException(); } $sp2a3d03 = Message::newMessage(json_encode($sp2b7469['attributes']['messageContents']), $spd4bab0->id, $sp12718f->id); $sp2a3d03->save(); $sp12718f->increment('total_messages'); ConversationUser::where(array(array('user_id', '=', $spd4bab0->id), array('conversation_id', '=', $sp12718f->id)))->update(array('cipher' => $sp2b7469['attributes']['cipher'])); foreach (ConversationUser::where('conversation_id', $sp12718f->id)->pluck('user_id')->all() as $spd5a94c) { if (intval($spd5a94c) !== intval($spd4bab0->id)) { User::find($spd5a94c)->increment('unread_messages'); $this->pushNewMessage($spd5a94c, $sp2a3d03, $sp12718f->id); } } $spd73b45 = $spd4bab0->id; $sp2a3d03->message = json_decode($sp2a3d03->message)->{$spd73b45}; return $sp2a3d03; } public function pushNewMessage($spd5a94c, $sp2a3d03, $sp71a176) { if (app()->bound(Pusher::class)) { app(Pusher::class)->trigger('private-user' . $spd5a94c, 'newMessage', array('id' => $sp2a3d03->id, 'message' => json_decode($sp2a3d03->message)->{$spd5a94c}, 'createdAt' => (new \DateTime($sp2a3d03->created_at))->format(\DateTime::RFC3339), 'conversationId' => $sp71a176)); } } }