<?php
namespace Kyrne\Shout\Commands; use Illuminate\Contracts\Bus\Dispatcher as BusDispatcher; use InvalidArgumentException; use Kyrne\Shout\Conversation; use Kyrne\Shout\ConversationUser; use Kyrne\Shout\Encryption; class StartConversationHandler { protected $bus; public function __construct(BusDispatcher $sp9afba9) { $this->bus = $sp9afba9; } public function handle(StartConversation $sp07d2ef) { $sp63f786 = $sp07d2ef->actor; $sp369360 = $sp07d2ef->data; $sp63f786->assertCan('startConversation'); if (intval($sp369360['attributes']['recipient']) === intval($sp63f786->id)) { throw new InvalidArgumentException(); } $sp735589 = ConversationUser::where('user_id', $sp63f786->id)->pluck('conversation_id')->all(); $sp3c85ab = null; foreach ($sp735589 as $sp9a6e86) { $spad5e71 = conversation::find($sp9a6e86); if (in_array($sp369360['attributes']['recipient'], $spad5e71->recipients()->pluck('user_id')->all())) { $sp3c85ab = $spad5e71; break; } } if ($sp3c85ab) { $sp3c85ab->notNew = true; return $sp3c85ab; } $spad5e71 = Conversation::start(); $spad5e71->save(); foreach (array_merge(array($sp63f786->id), (array) $sp369360['attributes']['recipient']) as $sp5789a3) { $sp5bdfea = new ConversationUser(); $sp5bdfea->conversation_id = $spad5e71->id; $sp5bdfea->user_id = $sp5789a3; if (intval($sp5789a3) === intval($sp63f786->id)) { $sp5bdfea->cipher = $sp369360['attributes']['cipher']; } $sp5bdfea->save(); } try { $this->bus->dispatch(new NewMessage($sp63f786, $sp369360, $spad5e71->id)); } catch (\Exception $spf96ebf) { $spad5e71->delete; throw $spf96ebf; } $spaaa5dd = Encryption::where('user_id', $sp369360['attributes']['recipient'])->first(); $spaaa5dd->increment('prekey_index'); if ($spaaa5dd->prekey_index > 47) { $spaaa5dd->prekeys_exhausted = true; } $spaaa5dd->save(); return $spad5e71; } }